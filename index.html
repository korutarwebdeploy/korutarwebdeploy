<!DOCTYPE html>
<html>

<head>
    <!--基础margin和padding设置，还有基本页面色调-->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <title>Model Properties Extraction</title>
    <style media="screen">
        * {
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
        }

        .main {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        .model {
            flex: 1;
        }

        .buttons {
            font-size: 0;
        }

        .valueInput {
            margin: 10px 0 10px 10px;
        }

        /*按钮个性化设置*/
        .button {
            margin: 10px 0 10px 10px;
            width: 100px;
            height: 45px;
            background: #FF9933;
            color: #ffffff;
            text-shadow: 0.9px 0.9px #000000;
            border-radius: 3px;
            border: none;
            cursor: pointer;
        }
    </style>

</head>

<body style="background-color: #2C3636;">
    <!--Button的名称设置-->
    <div class='main'>
        <div class='buttons'>
            <!-- <button type="button" class="button" onclick="getComponentProperty()">Element Properties</button> -->
            <button type="button" class="button" onclick="getFloors()">Floors Properties</button>
            <button type="button" class="button" onclick="getModelTree()">Model Tree Properties</button>
            <button type="button" class="button" onclick="exportElement()">Export Element Properties</button>
            <button type="button" class="button" onclick="elementId()">Get Elements IDs</button>
            <input type="text" size="20" class="valueInput" style="border-top: 50px;" placeholder="Key in your number here">
            <input type="submit">
        </div>

        <!-- 定义DOM元素，用于在该DOM元素中显示模型或图纸 -->
        <div class='model' id="domId"></div>
    </div>

    <!-- 引用BIMFACE的JavaScript显示组件库 -->
    <script src="https://static.bimface.com/api/BimfaceSDKLoader/BimfaceSDKLoader@latest-release.js" charset="utf-8">
    </script>

    <script type="text/javascript">
        var viewToken = '';
        // 声明Viewer及App
        var viewer3D;
        var app;

        // 判断场景是否加载完成
        var viewAdded = false;
        // 配置JSSDK加载项
        function initBimface(viewToken) {
            var loaderConfig = new BimfaceSDKLoaderConfig();
            loaderConfig.language = BimfaceLanguageOption.en_GB;
            loaderConfig.viewToken = viewToken;
            BimfaceSDKLoader.load(loaderConfig, successCallback, failureCallback);

            // 加载成功回调函数
            function successCallback(viewMetaData) {
                loadScript("https://static.bimface.com/attach/eb19d39099ef4cf1b53f333a7066694f_inflate.min.js");
                loadScript("https://static.bimface.com/attach/9b1a9a0eab054241974a2b1c436921bc_FBXLoader.js");
                var dom4Show = document.getElementById('domId');
                // 设置WebApplication3D的配置项
                var webAppConfig = new Glodon.Bimface.Application.WebApplication3DConfig();
                webAppConfig.domElement = dom4Show;
                //背景
                //webAppConfig.enableIBLBackground=true;
                //webAppConfig.loadIBLScene={IBLSceneOption: "ParkingLot", withBackground: true}
                // 创建WebApplication3D，用以显示模型
                app = new Glodon.Bimface.Application.WebApplication3D(webAppConfig);
                app.addView(viewToken);
                viewer3D = app.getViewer();
                viewer3D.addEventListener(Glodon.Bimface.Viewer.Viewer3DEvent.ViewAdded, function () {
                    viewer3D.enableSkyBox(true);
                    setCameraStatus()
                    var drawableConfig = new Glodon.Bimface.Plugins.Drawable.DrawableContainerConfig();
                    drawableConfig.viewer = viewer3D;
                    drawableContainer = new Glodon.Bimface.Plugins.Drawable.DrawableContainer(drawableConfig);
                    viewAdded = true;
                });
            }
            // 加载失败回调函数
            function failureCallback(error) {
                console.log(error);
            }
        }

        /*第一步加载你的模型*/
        var link = "https://api.bimface.com/preview/eba77d57";
        function get(url, success) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function () {
                if ((xhr.readyState == 4 && xhr.status == 200) || xhr.status == 304) {
                    success(xhr.responseText);
                }
            };
            xhr.send();
        }

        function resolveViewToken(content, success) {
            var matches = content.match(/viewToken = '.*'/gi);
            if (matches.length > 0) {
                var match = matches[0];
                var viewToken = match
                    .substr(match.indexOf("=") + 1)
                    .replace(/(^\s*)|(\s*$)/g, "")
                    .replace(/'/g, "");
                if (viewToken) success(viewToken);
            }
        }

        function view(publicLink) {
            get(publicLink, function (content) {
                resolveViewToken(content, initBimface);
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            view(link);
        });

        /****************************/
        /*第二步加载你想要的模型视角*/
        function setCameraStatus() {
            viewer3D.setCameraStatus();
        }

        // ************************** 添加外部构件 **************************
        // 构件库地址：https://bimface.com/objectlib

        var isExternalObjectAdded = false;
        var mixer;
        var action;
        function addExternalObject() {
            if (!viewAdded || isExternalObjectAdded) {
                return;
            }
            var fbxUrl = "https://static.bimface.com/attach/4de9cdd471b14b7484bfb00efa68ecf5_Samba%20Dancing.fbx";
            // 构造FBX加载器
            var loader = new FBXLoader();
            // 通过加载器加载资源，获取FBX对象
            loader.load(fbxUrl, function (object) {
                // 将该对象添加为外部构件
                viewer3D.addExternalObject("robot", object);
                isExternalObjectAdded = true;
                // 将构件移至初始位置
                setTransform("robot", new THREE.Vector3(816.7942341517311, 780.7235233162809, -0.019379019705746514), new THREE.Vector3(10, 10, 10), new THREE.Vector3(Math.PI / 2, 0, 0));
                viewer3D.render();
                // 构造FBX构件的动画播放器
                mixer = new THREE.AnimationMixer(object);
                action = mixer.clipAction(object.animations[0]);
                action.play();
            });
        }

        // 对外部构件进行平移、缩放和旋转
        function setTransform(name, position, scale, rotation) {
            // 获取构件对象
            var object = viewer3D.getExternalObjectByName(name);
            if (!object) {
                return;
            }
            // 构件平移
            if (position) {
                object.position.x += position.x;
                object.position.y += position.y;
                object.position.z += position.z;
            }
            // 构件缩放
            if (scale) {
                object.scale.x *= scale.x;
                object.scale.y *= scale.y;
                object.scale.z *= scale.z;
            }
            // 构件旋转
            if (rotation) {
                object.rotation.x += rotation.x;
                object.rotation.y += rotation.y;
                object.rotation.z += rotation.z;
            }
            // 更新构件
            object.updateMatrixWorld();
            viewer3D.render();
        }

        // ************************** 设置FBX动画 **************************
        var isAnimationActivated = false;
        var animationId;
        function fbxAnimation() {
            addExternalObject();
            //   if (!viewAdded || !isExternalObjectAdded) {
            //     return;
            //   }
            var clock = new THREE.Clock();
            if (!isAnimationActivated) {
                function animate() {
                    animationId = requestAnimationFrame(animate);
                    var delta = clock.getDelta();
                    if (mixer) {
                        mixer.update(delta);
                        viewer3D.getExternalObjectByName("robot").updateMatrixWorld();
                        viewer3D.render();
                    }
                }
                animate();
                isAnimationActivated = true;
                setButtonText("btnAnimation", "Hide Animation");
            } else {
                cancelAnimationFrame(animationId);
                viewer3D.removeExternalObjectByName("robot")
                viewer3D.render();
                isAnimationActivated = false;
                setButtonText("btnAnimation", "Animation");
            }
        }

        // 加载js脚本
        function loadScript(url, callback) {
            var script = document.createElement("script");
            script.type = "text/javascript";
            script.onload = function () {
                callback && callback();
            }
            script.src = url;
            document.head.appendChild(script);
        }

        // ************************** 按钮文字 **************************
        function setButtonText(btnId, text) {
            var dom = document.getElementById(btnId);
            if (dom != null && dom.nodeName == "BUTTON") {
                dom.innerText = text;
            }
        }
        //功能失败回弹
        function failureCallback(error) {
            console.log(error);
        }
        //Element功能驱使
        function getComponentProperty() {
            viewer3D.getComponentProperty("307240", function (objectdata) {
                alert(JSON.stringify(objectdata));
            });
        }
        //Floor功能驱使
        function getFloors() {
            viewer3D.getFloors(function (objectdata) {
                alert(JSON.stringify(objectdata));
            });
        }
        //ModelTree功能驱使
        function getModelTree() {
            viewer3D.getModelTree(function (objectdata) {
                alert(JSON.stringify(objectdata));
            });
        }


        /**********Get Element IDs**********/
        //ElementID功能驱使
        function elementId(){
            fetch('https://api.bimface.com/data/v2/files/1981789648390336/elementIds',{
                headers: {
                    "Content-Type":"application/json",
                    "Authorization": "Bearer cn-6d051ce5-03d5-4991-9182-9f7ac541f307",
                },
                method: 'GET',
            })
            // Handle success
            response.text().then(function (text) {
            // do something with the text response
            });
        }


        /**********Export Element**********/
        //ExportElement功能驱使
        function exportElement(){
            fetch('https://api.bimface.com/data/v2/files/1981789648390336/elements?includeOverrides=true',{
                headers: {
                    "Content-Type":"application/json",
                    "Authorization": "Bearer cn-6d051ce5-03d5-4991-9182-9f7ac541f307",
                },
                method: 'POST',
                body: JSON.stringify({
                    "elementIds" : ["59916","45500","99284","82865","60108","85860","39073","85541","90163","31178","82196","94511","96475","12976","84295","51825","23761","26850","67831","89329","69882","61895","99139","90638","75132","63784","28100","39605","75469","67594","23862","35807","35083","22549","66789","86832","27106","28624","77920","93251","95671","10802","63299","11780","82328","99569","46590","26338","47658","48003","66559","41603","33227","62239","18130","38530","9892","68807","21034","99474","57850","3240","93118","88987","76817","62739","49203","22145","44168","50199","64138","86262","77136","19992","17580","57505","78467","98507","65642","5645","86642","64253","54071","75754","84105","18263","88715","21842","46052","29901","74331","52764","81379","91303","36923","57620","13360","78752","46850","67946","41738","36513","69100","68061","47888","961","57275","46259","9124","11982","94117","39871","62639","96083","5911","80467","91208","73744","63507","2956","44853","8996","86357","100199","75944","1228","21135","45211","99908","22448","92675","26082","98400","24266","17997","88405","85753","42953","65403","96865","21438","101422","60536","141","95226","4581","84939","37599","9252","27746","25826","80599","57160","27618","15920","47030","38264","92780","56259","79006","86737","12285","8316","97469","16560","77548","88500","67709","30425","25186","87848","90448","40150","46328","93007","97574","90258","84535","64023","12083","72512","83155","45638","92887","1491","11376","57045","61795","7108","97976","27490","76324","84844","10674","77029","48181","52875","23256","43898","19061","48756","62439","4182","94701","354","34821","47407","23458","23660","93374","87446","93984","94941","19726","81152","9764","698","54972","85329","79608","59230","79377","17447","101363","37189","50830","11679","77655","49509","72010","36646","4714","22246","42278","97776","62006","53319","43628","98083","64828","3650","11578","66273","45391","44033","45914","98295","20425","3916","100296","26466","11881","48411","93506","50429","87541","11058","68577","47261","48641","37998","79703","1642","76134","79893","8582","72126","7917","66674","96285","81511","54493","84200","90828","6044","45707","69024","94606","63654","59584","50084","63908","54282","4049","38940","58885","27874","76593","52036","12184","72977","83440","23357","38674","72856","1775","59814","47528","21236","17731","61573","29148","53108","96380","78562","17181","65987","96665","2438","89234","79497","81969","80735","54182","37056","93737","5246","10930","58425","97871","84010","17314","51925","55175","12386","84440","95871","45776","56355","48105","73334","42818","69195","10020","24468","68232","13872","97681","3384","58540","56585","46121","40004","22751","90068","36228","44642","89123","47773","85129","25570","65288","147","22852","78037","77750","46190","15152","77231","49739","1912","86060","98819","5778","59699","32706","2171","92020","100102","19194","39472","6576","53441","97067","65058","43223","100005","24569","2701","24165","87032","44303","22044","39339","76712","59992","35390","95766","6842","56815","89828","6310","14512","65872","78372","51281","90923","14000","74752","75849","45845","23559","32455","4315","84640","44772","36790","17048","24930","82464","78182","67249","61451","4448","82076","14384","11163","15408","21640","34487","90543","12588","7784","83010","64943","15792","14896","95346","23054","97172","41468","91542","65757","67364","30676","85955","40592","11477","37732","98697","54893","73668","72735","71430","73449","69386","43358","34225","20551","88595","50600","86927","12487","67019","88851","26594","5512","33472","10276","9508","88199","86452","38807","54593","94366","99811","78277","24802","81849","10413","101118","45280","16304","64598","42413","78657","30927","74446","56470","84749","76039","68156","65527","63396","39206","83535","95131","66388","2813","83630","36380","50314","74847","16688","14640","3783","91408","75564","72614","83915","68692","46919","20935","81618","61684","92463","75659","59000","79270","40446","23963","22953","52656","85224","83250","16048","45142","98602","31429","37865","65173","82575","61343","97374","55039","14768","80347","9636","92568","94796","24367","59115","92232","41030","83345","7374","26210","22347","48986","58080","18396","68347","18795","73092","96972","55322","21943","74095","159","45569","25314","43088","89733","21337","40738","71188","66082","92352","82720","8050","100560","56700","43493","31691","95036","8740","68462","21741","46439","30163","87351","83725","27362","87741","28362","39738","49279","52997","41873","91773","28886","75279","53974","105","89586","49394","42143","70290","25698","91653","120","153","92125","70666","77443","19460","15024","75374","79138","12848","32204","37333","93617","80108","99379","24670","47139","40300","79988","135","59345","64368","33964","67479","17864","94255","98924","95978","64483","80937","73213","15536","71089","15280","51717","41176","31953","42008","44478","98188","18662","21539","29650","16816","91113","53208","89923","81259","49854","58195","29399","95459","13616","81032","15664","59469","50524","87968","58310","69271","90353","14128","97279","45983","44922","19859","32957","22650","64713","6975","96190","100873","99031","78872","79798","74563","87244","88079","57735","23155","46741","76924","87139","58655","85648","66904","74942","75037","27234","25442","35530","10148","16432","11275","12720","73974","19593","37466","66158","93873","49108","49624","77336","13488","6709","73859","85034","24064","45033","60633","81738","5113","3517","53563","88310","83820","76419","62117","8868","6443","7507","66483","9380","36084","91018","58770","40884","86167","50715","57390","8449","80240","13232","49969","10548","76229","6177","56930","43763","89430","67134","91909","19327","13104","95564","80842","14256","13744","90733","41322","74210","68922","38397","16944","54693","85436","42683","25058","96570","87636","71307","18928","48296","25954","54382","48526","96760","16176","4980","8183","18529","62339","42548","20679","3107","4847","26722","54793","7241","5379","20258","35951","7640","62539","48871","57965","86547","20807","33738","99664","26978","20125","38131","73564"],
                    "filter" : [ {
                        "group" : "default"
                    }, {
                        "group" : "shape"
                    }, {
                        "group" : "size",
                        "keys" : [ "length", "width", "a" ]
                    } ]
                    })
            })
            // Handle success
            .then(response => response.text())
            .then(data=> console.log(data))
            .catch(error => console.error(error))
        }

    </script>

</body>

</html>